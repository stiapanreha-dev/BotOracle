# üéØ –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è CRM —Å–∏—Å—Ç–µ–º–∞ - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## üìñ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π Cadence

### Level 1: NORMAL (–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
- **–¢—Ä–∏–≥–≥–µ—Ä**: < 2 –¥–Ω–µ–π –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ CRM –∫–æ–Ω—Ç–∞–∫—Ç—ã
- **–ß–∞—Å—Ç–æ—Ç–∞**: –∫–∞–∂–¥—ã–µ 2 –¥–Ω—è, –¥–æ 3 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤/–¥–µ–Ω—å
- **–¢–∏–ø—ã –∑–∞–¥–∞—á**: –í–°–ï (PING, NUDGE_SUB, DAILY_MSG, RECOVERY, LIMIT_INFO)
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ê–∫—Ç–∏–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –ø–æ–ª–Ω—ã–π CRM —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### Level 2: REDUCED (–°–Ω–∏–∂–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)
- **–¢—Ä–∏–≥–≥–µ—Ä**: 2-13 –¥–Ω–µ–π –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ CRM –∫–æ–Ω—Ç–∞–∫—Ç—ã
- **–ß–∞—Å—Ç–æ—Ç–∞**: 1 —Ä–∞–∑ –≤ 5-7 –¥–Ω–µ–π, –¥–æ 1 –∫–æ–Ω—Ç–∞–∫—Ç–∞/–Ω–µ–¥–µ–ª—é
- **–¢–∏–ø—ã –∑–∞–¥–∞—á**: –¢–û–õ–¨–ö–û DAILY_MSG_PROMPT + –º—è–≥–∫–∏–µ RECOVERY
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –î–µ–ª–∏–∫–∞—Ç–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ, –Ω–µ –¥–∞–≤–∏–º –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### Level 3: STOPPED (–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- **–¢—Ä–∏–≥–≥–µ—Ä**: 14+ –¥–Ω–µ–π –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ CRM –∫–æ–Ω—Ç–∞–∫—Ç—ã
- **–ß–∞—Å—Ç–æ—Ç–∞**: 0 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–ø–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
- **–¢–∏–ø—ã –∑–∞–¥–∞—á**: –ù–ò–ö–ê–ö–ò–ï (–≤—Å–µ CRM –∑–∞–¥–∞—á–∏ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è)
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –£–≤–∞–∂–µ–Ω–∏–µ –∫ –≥—Ä–∞–Ω–∏—Ü–∞–º, –∂–¥–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–í–∞–∂–Ω–æ**: –ö–Ω–æ–ø–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç, –ª—é–±–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ Level 1

### ‚ö° –ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è "–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ CRM"?
–õ—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ—á–µ–Ω–∏–µ **48 —á–∞—Å–æ–≤** –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ CRM –∫–æ–Ω—Ç–∞–∫—Ç–∞ (PING, NUDGE_SUB, DAILY_MSG_PROMPT, RECOVERY, LIMIT_INFO).

### üîÑ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
–ü—Ä–∏ –ª—é–±–æ–º –æ—Ç–≤–µ—Ç–µ –Ω–∞ CRM –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ Level 1.

---

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (State Machine)

```mermaid
stateDiagram-v2
    [*] --> Level1_Normal

    Level1_Normal: Level 1: NORMAL
    Level2_Reduced: Level 2: REDUCED
    Level3_Stopped: Level 3: STOPPED

    Level1_Normal --> Level2_Reduced: 2 –¥–Ω—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ CRM
    Level2_Reduced --> Level3_Stopped: 14 –¥–Ω–µ–π –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ CRM

    Level2_Reduced --> Level1_Normal: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª
    Level3_Stopped --> Level1_Normal: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª

    note right of Level1_Normal
        –ß–∞—Å—Ç–æ—Ç–∞: –∫–∞–∂–¥—ã–µ 2 –¥–Ω—è
        –ö–æ–Ω—Ç–∞–∫—Ç—ã: –¥–æ 3/–¥–µ–Ω—å
        –¢–∏–ø—ã: ALL (PING, NUDGE, DAILY, RECOVERY)
        –ê–∫—Ç–∏–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
    end note

    note right of Level2_Reduced
        –ß–∞—Å—Ç–æ—Ç–∞: 1 —Ä–∞–∑ –≤ 5 –¥–Ω–µ–π
        –ö–æ–Ω—Ç–∞–∫—Ç—ã: 1/–¥–µ–Ω—å max
        –¢–∏–ø—ã: DAILY_MSG, –º—è–≥–∫–∏–µ RECOVERY
        –î–µ–ª–∏–∫–∞—Ç–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
    end note

    note right of Level3_Stopped
        –ß–∞—Å—Ç–æ—Ç–∞: 0 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
        –ö–æ–Ω—Ç–∞–∫—Ç—ã: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
        –¢–∏–ø—ã: –Ω–∏–∫–∞–∫–∏–µ
        –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    end note
```

## üîÑ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã (Sequence Diagram)

```mermaid
sequenceDiagram
    participant U as User
    participant H as oracle_handlers.py
    participant P as planner.py
    participant D as dispatcher.py
    participant DB as Database

    Note over P: Daily CRM Planning Job (00:00 UTC)

    P->>DB: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        P->>DB: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å last_crm_response_at
        P->>P: –í—ã—á–∏—Å–ª–∏—Ç—å days_since_response

        alt days_since_response >= 14
            P->>DB: SET crm_cadence_level = 3 (STOPPED)
            P->>DB: –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ pending –∑–∞–¥–∞—á–∏
            Note over P: –ù–∏–∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
        else days_since_response >= 2
            P->>DB: SET crm_cadence_level = 2 (REDUCED)
            P->>P: –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏: DAILY_MSG, RECOVERY (1 —Ä–∞–∑ –≤ 5 –¥–Ω–µ–π)
            P->>DB: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ admin_tasks
        else days_since_response < 2
            P->>DB: SET crm_cadence_level = 1 (NORMAL)
            P->>P: –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏: PING, NUDGE, DAILY, RECOVERY, LIMIT_INFO
            P->>DB: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á–∏ (–¥–æ 3/–¥–µ–Ω—å)
        end
    end

    Note over D: Dispatcher Job (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

    D->>DB: –ü–æ–ª—É—á–∏—Ç—å due –∑–∞–¥–∞—á–∏
    loop –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
        D->>U: –û—Ç–ø—Ä–∞–≤–∏—Ç—å CRM —Å–æ–æ–±—â–µ–Ω–∏–µ
        D->>DB: –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ sent
    end

    Note over U,H: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç

    U->>H: –õ—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    H->>DB: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –±—ã–ª –ª–∏ –Ω–µ–¥–∞–≤–Ω–∏–π CRM –∫–æ–Ω—Ç–∞–∫—Ç (48h)?

    alt CRM –∫–æ–Ω—Ç–∞–∫—Ç –±—ã–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 48h
        H->>DB: UPDATE last_crm_response_at = NOW()
        H->>DB: SET crm_cadence_level = 1 (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
        H->>DB: –°–æ–±—ã—Ç–∏–µ: cadence_level_restored
        Note over H: –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ Level 1!
    else –ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–µ–≥–æ CRM
        Note over H: –û–±—ã—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    end

    H->>DB: UPDATE last_seen_at = NOW()
    H->>U: –û—Ç–≤–µ—Ç –æ—Ç Admin/Oracle
```

## üåä –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –ª–æ–≥–∏–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (Flowchart)

```mermaid
flowchart TD
    Start([CRM Planner –∑–∞–ø—É—â–µ–Ω]) --> GetUsers[–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π]
    GetUsers --> ForEach{–î–ª—è –∫–∞–∂–¥–æ–≥–æ<br/>–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è}

    ForEach -->|User| CheckResponse[–ü—Ä–æ–≤–µ—Ä–∏—Ç—å last_crm_response_at]
    CheckResponse --> CalcDays[–í—ã—á–∏—Å–ª–∏—Ç—å days_since_response]

    CalcDays --> Level3Check{days >= 14?}
    Level3Check -->|–î–∞| SetLevel3[SET crm_cadence_level = 3]
    SetLevel3 --> CancelTasks[–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ pending –∑–∞–¥–∞—á–∏]
    CancelTasks --> LogStop[LOG: cadence_stopped]
    LogStop --> NoTasks[‚úó –ó–∞–¥–∞—á–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è]
    NoTasks --> NextUser

    Level3Check -->|–ù–µ—Ç| Level2Check{days >= 2?}
    Level2Check -->|–î–∞| SetLevel2[SET crm_cadence_level = 2]
    SetLevel2 --> ReducedTasks[–°–æ–∑–¥–∞—Ç—å REDUCED –∑–∞–¥–∞—á–∏]
    ReducedTasks --> DailyMsg[+ DAILY_MSG_PROMPT]
    DailyMsg --> Recovery5d{–ü—Ä–æ—à–ª–æ 5 –¥–Ω–µ–π<br/>—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ RECOVERY?}
    Recovery5d -->|–î–∞| AddRecovery[+ RECOVERY –º—è–≥–∫–∏–π]
    Recovery5d -->|–ù–µ—Ç| SaveReduced
    AddRecovery --> SaveReduced[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å 1-2 –∑–∞–¥–∞—á–∏]
    SaveReduced --> LogReduced[LOG: cadence_reduced]
    LogReduced --> NextUser

    Level2Check -->|–ù–µ—Ç| SetLevel1[SET crm_cadence_level = 1]
    SetLevel1 --> NormalTasks[–°–æ–∑–¥–∞—Ç—å NORMAL –∑–∞–¥–∞—á–∏]

    NormalTasks --> CheckDaily{DAILY_MSG<br/>—É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω?}
    CheckDaily -->|–ù–µ—Ç| AddDaily[+ DAILY_MSG_PROMPT]
    CheckDaily -->|–î–∞| CheckPing
    AddDaily --> CheckPing

    CheckPing{PING –Ω—É–∂–µ–Ω?<br/>–ø—Ä–æ—à–ª–æ 2 –¥–Ω—è?}
    CheckPing -->|–î–∞| AddPing[+ PING]
    CheckPing -->|–ù–µ—Ç| CheckNudge
    AddPing --> CheckNudge

    CheckNudge{NUDGE_SUB –Ω—É–∂–µ–Ω?<br/>–Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ +<br/>–ø—Ä–æ—à–ª–æ 48h +<br/>< 2/–Ω–µ–¥–µ–ª—é?}
    CheckNudge -->|–î–∞| AddNudge[+ NUDGE_SUB]
    CheckNudge -->|–ù–µ—Ç| CheckLimit
    AddNudge --> CheckLimit

    CheckLimit{LIMIT_INFO –Ω—É–∂–µ–Ω?<br/>–æ—Å—Ç–∞–ª–æ—Å—å 1-2<br/>–±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞?}
    CheckLimit -->|–î–∞| AddLimit[+ LIMIT_INFO]
    CheckLimit -->|–ù–µ—Ç| CheckRecovery
    AddLimit --> CheckRecovery

    CheckRecovery{RECOVERY –Ω—É–∂–µ–Ω?<br/>3+ –¥–Ω—è –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω?}
    CheckRecovery -->|–î–∞| AddRecoveryNormal[+ RECOVERY]
    CheckRecovery -->|–ù–µ—Ç| SelectTasks
    AddRecoveryNormal --> SelectTasks

    SelectTasks[–í—ã–±—Ä–∞—Ç—å –¥–æ 3 –∑–∞–¥–∞—á<br/>–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É]
    SelectTasks --> ScheduleTasks[–†–∞—Å–ø–∏—Å–∞—Ç—å –Ω–∞ –¥–µ–Ω—å<br/>—Å —É—á–µ—Ç–æ–º quiet hours]
    ScheduleTasks --> SaveNormal[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á–∏]
    SaveNormal --> LogNormal[LOG: cadence_normal]
    LogNormal --> NextUser

    NextUser --> ForEach
    ForEach -->|–í—Å–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã| Stats[–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É]
    Stats --> End([–ó–∞–≤–µ—Ä—à–µ–Ω–æ])

    style SetLevel3 fill:#ff6b6b
    style SetLevel2 fill:#ffa94d
    style SetLevel1 fill:#51cf66
    style NoTasks fill:#ff6b6b,stroke:#c92a2a
    style SaveReduced fill:#ffa94d,stroke:#e67700
    style SaveNormal fill:#51cf66,stroke:#2f9e44
```

## üîî –¢—Ä–∏–≥–≥–µ—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (Activity Diagram)

```mermaid
flowchart LR
    UserMsg[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å<br/>–æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ] --> Handler[oracle_handlers.py<br/>question_handler]

    Handler --> CheckCRM{–ë—ã–ª –ª–∏ CRM –∫–æ–Ω—Ç–∞–∫—Ç<br/>–≤ —Ç–µ—á–µ–Ω–∏–µ 48h?}

    CheckCRM -->|–î–∞| IsResponse[–≠—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ CRM!]
    IsResponse --> UpdateResponse[UPDATE<br/>last_crm_response_at]
    UpdateResponse --> CheckLevel{current level > 1?}

    CheckLevel -->|–î–∞| Restore[SET crm_cadence_level = 1]
    Restore --> LogRestore[LOG:<br/>cadence_level_restored]
    LogRestore --> Success[‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ Level 1]

    CheckLevel -->|–ù–µ—Ç| Already[–£–∂–µ –Ω–∞ Level 1]

    CheckCRM -->|–ù–µ—Ç| NotResponse[–û–±—ã—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br/>–Ω–µ CRM –æ—Ç–≤–µ—Ç]
    NotResponse --> UpdateSeen[UPDATE last_seen_at]

    Success --> Continue[–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å<br/>–æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è]
    Already --> Continue
    UpdateSeen --> Continue

    style IsResponse fill:#4dabf7
    style Restore fill:#51cf66
    style Success fill:#51cf66,stroke:#2f9e44
    style NotResponse fill:#adb5bd
```

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (ER Diagram)

```mermaid
erDiagram
    users ||--o{ admin_tasks : has
    users ||--|| contact_cadence : has
    users {
        int id PK
        int tg_user_id
        timestamp last_seen_at
        timestamp last_crm_response_at "NEW: –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ CRM"
        int crm_cadence_level "NEW: 1=Normal, 2=Reduced, 3=Stopped"
        string crm_stopped_reason "NEW: –ø–æ—á–µ–º—É –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
        int free_questions_left
        bool is_blocked
    }

    admin_tasks {
        bigint id PK
        int user_id FK
        string type "PING, NUDGE_SUB, DAILY_MSG_PROMPT, RECOVERY..."
        string status "scheduled, due, sent, replied, failed"
        timestamp due_at
        timestamp sent_at
        jsonb payload
    }

    contact_cadence {
        int user_id PK_FK
        int days_between_pings
        int days_between_nudges
        jsonb prefers_windows
        int postpone_on_reply
    }

    events {
        bigint id PK
        int user_id FK
        string type "cadence_level_changed, cadence_stopped, cadence_restored"
        jsonb meta
        timestamp occurred_at
    }
```

## üéÆ –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–Ω–∏–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```mermaid
gantt
    title –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å
    dateFormat YYYY-MM-DD
    axisFormat %d %b

    section Level 1
    –ê–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥           :done, l1, 2025-01-01, 5d
    CRM: PING –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω       :crit, crm1, 2025-01-03, 1d
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª   :active, wait1, 2025-01-04, 2d

    section Level 2
    –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Level 2        :milestone, m1, 2025-01-06, 0d
    CRM: DAILY_MSG —Ç–æ–ª—å–∫–æ     :crm2, 2025-01-08, 1d
    CRM: –º—è–≥–∫–∏–π RECOVERY      :crm3, 2025-01-13, 1d
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–ª—á–∏—Ç       :active, wait2, 2025-01-06, 12d

    section Level 3
    –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Level 3        :milestone, m2, 2025-01-18, 0d
    –í—Å–µ CRM –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã       :crit, stop, 2025-01-18, 5d
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
```mermaid
gantt
    title –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è
    dateFormat YYYY-MM-DD
    axisFormat %d %b

    section Level 2
    Reduced —Ä–µ–∂–∏–º             :done, l2, 2025-01-01, 5d
    CRM: RECOVERY –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω   :crit, crm, 2025-01-04, 1d

    section –û—Ç–≤–µ—Ç
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª!     :milestone, resp, 2025-01-05, 0d

    section Level 1
    –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ :active, restore, 2025-01-05, 1d
    Normal —Ä–µ–∂–∏–º –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω  :l1, 2025-01-06, 5d
    CRM: PING, NUDGE, DAILY   :crm2, 2025-01-07, 1d
```

## üîß –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ CRM
```python
async def is_response_to_crm(user_id: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±—ã–ª –ª–∏ –Ω–µ–¥–∞–≤–Ω–∏–π CRM –∫–æ–Ω—Ç–∞–∫—Ç (48h)
    –∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –Ω–µ–≥–æ
    """
    last_crm = await get_last_crm_sent_time(user_id)
    if not last_crm:
        return False

    hours_since = (datetime.now() - last_crm).total_seconds() / 3600
    return hours_since <= 48
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è cadence
```python
async def update_cadence_level(user_id: int) -> int:
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç crm_cadence_level
    –Ω–∞ –æ—Å–Ω–æ–≤–µ last_crm_response_at
    """
    user = await UserModel.get_by_id(user_id)
    last_response = user.get('last_crm_response_at')

    if not last_response:
        return 1  # Default: Normal

    days_since = (datetime.now() - last_response).days

    if days_since >= 14:
        level = 3  # STOPPED
    elif days_since >= 2:
        level = 2  # REDUCED
    else:
        level = 1  # NORMAL

    await set_cadence_level(user_id, level)
    return level
```

### 3. –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
```python
async def restore_cadence_on_response(user_id: int):
    """
    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Level 1 –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ CRM
    """
    current_level = await get_cadence_level(user_id)

    if current_level > 1:
        await set_cadence_level(user_id, 1)
        await set_last_crm_response(user_id, datetime.now())

        await EventModel.log_event(
            user_id=user_id,
            event_type='cadence_level_restored',
            meta={'from_level': current_level, 'to_level': 1}
        )

        logger.info(f"User {user_id} re-engaged! Restored from Level {current_level} to Level 1")
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°–æ–±—ã—Ç–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:
- `cadence_level_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
- `cadence_level_restored` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `cadence_stopped` - –ø–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ CRM
- `crm_response_detected` - –æ–±–Ω–∞—Ä—É–∂–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ CRM

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è dashboard:
- % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –∫–∞–∂–¥–æ–º level (1/2/3)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ Level 2 –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏—Ö—Å—è —Å Level 3
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å CRM –ø–æ —É—Ä–æ–≤–Ω—è–º (response rate)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-01-17
**–í–µ—Ä—Å–∏—è**: 1.0
**–°—Ç–∞—Ç—É—Å**: Design Complete, Ready for Implementation
